name: "Crystal CI - Verify generated vendor vectors"

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

jobs:
  build:
    name: Verify generated vendor vectors
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive
      - name: Mark repository safe for Git (CI container)
        shell: bash
        run: |
          # Git may detect 'dubious ownership' inside the container; mark workspace safe for CI
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          # Install meson and ninja (APT/APK/DNF/pip fallback) so C build steps work in the container
          if ! command -v meson >/dev/null || ! command -v ninja >/dev/null; then
            if command -v apt-get >/dev/null; then
              apt-get update && apt-get install -y meson ninja-build
            elif command -v apk >/dev/null; then
              apk add --no-cache meson ninja
            elif command -v dnf >/dev/null; then
              dnf install -y meson ninja-build
            else
              python3 -m pip install --user meson ninja
              export PATH="$HOME/.local/bin:$PATH"
            fi
          fi

          shards install --ignore-crystal-version || true

      - name: Run generator
        shell: bash
        run: |
          set -euo pipefail
          crystal scripts/generate_vectors.cr

      - name: Verify fixtures are up-to-date
        shell: bash
        run: |
          set -euo pipefail
          git --no-pager status --porcelain
          if ! git diff --exit-code -- spec/fixtures; then
            echo "::error ::Generated fixtures are out of date. Run 'crystal scripts/generate_vectors.cr' and commit the changes."
            git --no-pager --no-color diff -- spec/fixtures
            exit 1
          fi

      - name: Run generator spec
        run: crystal spec spec/generate_vectors_spec.cr
