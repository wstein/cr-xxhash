name: "Verify generated vendor vectors"

on:
  pull_request:
    paths:
      - 'scripts/generate_vectors.cr'
      - 'spec/fixtures/**'
      - 'spec/support/vector_loader.cr'
      - 'spec/generate_vectors_spec.cr'
      - 'README.md'
  push:
    branches: [ main ]

jobs:
  verify-generated-vectors:
    name: Check generated vendor vectors
    runs-on: ubuntu-latest
    # use Crystal Docker image so `crystal` is available in the runner
    container: crystal:1.19

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify crystal is available
        run: crystal --version

      - name: Run generator
        run: |
          set -euo pipefail
          crystal scripts/generate_vectors.cr

      - name: Verify fixtures are up-to-date
        run: |
          set -euo pipefail
          # show any repo changes for debugging
          git --no-pager status --porcelain
          # fail if any fixture files would be changed by the generator
          git diff --exit-code -- spec/fixtures || (
            echo "::error ::Generated fixtures are out of date. Run 'crystal scripts/generate_vectors.cr' and commit the changes." 
            && git --no-pager --no-color diff -- spec/fixtures
            && exit 1
          )

      - name: Run generator spec
        run: crystal spec spec/generate_vectors_spec.cr
