name: "Crystal CI - Verify generated vendor vectors"

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "develop" ]

jobs:
  build:
    name: Verify generated vendor vectors
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install dependencies
        shell: bash
        run: |
          set -eu
          shards install --ignore-crystal-version || true

      - name: Run generator
        shell: bash
        run: |
          set -eu
          crystal scripts/generate_vectors.cr

      - name: Verify fixtures are up-to-date
        shell: bash
        run: |
          set -eu
          git --no-pager status --porcelain
          git diff --exit-code -- spec/fixtures || (
            echo "::error ::Generated fixtures are out of date. Run 'crystal scripts/generate_vectors.cr' and commit the changes."
            && git --no-pager --no-color diff -- spec/fixtures
            && exit 1
          )

      - name: Run generator spec
        run: crystal spec spec/generate_vectors_spec.cr
