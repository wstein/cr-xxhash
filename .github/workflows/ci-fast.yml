name: "Crystal CI - Fast (PR smoke)"

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

jobs:
  fast-tests:
    name: Fast tests â€” Unit + Generator check
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Mark repository safe for Git (CI container)
        shell: bash
        run: |
          # Git may detect 'dubious ownership' inside the container; mark workspace safe for CI
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          shards install --ignore-crystal-version || true

          # Ensure vendored C library is present â€” some CI images skip postinstall hooks
          if [ -f vendor/xxHash/Makefile ]; then
            echo "Building vendored xxHash C library (ensure xxhash.o/libxxhash.a)..."
            make -C vendor/xxHash xxhash.o libxxhash.a
          fi

      - name: Run unit tests
        shell: bash
        run: |
          set -euo pipefail
          echo "Running unit tests (fast smoke tests)..."
          # Run only unit tests (excluding integration and slow tests)
          crystal spec spec/unit/ spec/bindings_safe_spec.cr spec/version_spec.cr 2>&1 | tee test-output.log

          # Extract summary
          if grep -q "0 failures\|0 errors" test-output.log; then
            echo "âœ… Unit tests passed"
          else
            echo "âŒ Unit tests failed"
            exit 1
          fi

      - name: Verify generated vectors are up-to-date
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking if generated vectors need refresh..."

          # Run generator to ensure vectors are current
          crystal scripts/generate_vectors.cr

          # Check for uncommitted changes
          if ! git diff --exit-code -- spec/fixtures &>/dev/null; then
            echo "::error ::Generated fixtures are out of date!"
            echo "Run 'crystal scripts/generate_vectors.cr' locally and commit the changes."
            git --no-pager --no-color diff -- spec/fixtures | head -100
            exit 1
          else
            echo "âœ… Generated vectors are up-to-date"
          fi

      - name: Run generator spec
        shell: bash
        run: |
          set -euo pipefail
          echo "Running generator spec..."
          crystal spec spec/generate_vectors_spec.cr

      - name: Test summary
        if: always()
        shell: bash
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PR Smoke Test Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  âœ… Unit tests: PASSED"
          echo "  âœ… Generator check: PASSED"
          echo "  âœ… Generator spec: PASSED"
          echo ""
          echo "  Ready for merge! ğŸš€"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
