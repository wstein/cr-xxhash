name: "Crystal CI - Fast (PR smoke)"

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

jobs:
  fast-tests:
    name: Fast tests — Unit + Generator check
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Mark repository safe for Git (CI container)
        shell: bash
        run: |
          # Git may detect 'dubious ownership' inside the container; mark workspace safe for CI
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          # Install meson and ninja (APT/APK/DNF/pip fallback) so C build steps work in the container
          if ! command -v meson >/dev/null || ! command -v ninja >/dev/null; then
            if command -v apt-get >/dev/null; then
              # ensure package lists are fresh (fix missing libevent-dev error)
              apt-get update
              apt-get install -y meson ninja-build
            elif command -v apk >/dev/null; then
              apk add --no-cache meson ninja
            elif command -v dnf >/dev/null; then
              dnf install -y meson ninja-build
            else
              python3 -m pip install --user meson ninja
              export PATH="$HOME/.local/bin:$PATH"
            fi
          fi

          # Initialize nested xxHash submodule inside xxhash-wrapper
          # (shards install may skip postinstall hooks in CI)
          if [ -d vendor/xxhash-wrapper ]; then
            cd vendor/xxhash-wrapper
            git submodule update --init --recursive vendor/xxHash || true
            cd - >/dev/null
          fi

          shards install --ignore-crystal-version || true

          # Ensure wrapper static library is present — some CI images skip postinstall hooks
          if [ -f vendor/xxhash-wrapper/meson.build ]; then
            echo "Building vendored xxhash-wrapper static library..."
            # specify source directory explicitly so meson can find meson.build on CI
            meson setup vendor/xxhash-wrapper/build vendor/xxhash-wrapper --wipe 2>/dev/null || meson setup vendor/xxhash-wrapper/build vendor/xxhash-wrapper
            meson compile -C vendor/xxhash-wrapper/build
            ln -sf libxxh3_wrapper_static.a vendor/xxhash-wrapper/build/libxxh3_wrapper.a || true
          fi

      - name: Run unit tests
        shell: bash
        run: |
          set -euo pipefail
          echo "Running unit tests (fast smoke tests)..."
          # Run only unit tests (excluding integration and slow tests)
          crystal spec spec/unit/ spec/bindings_safe_spec.cr spec/version_spec.cr 2>&1 | tee test-output.log

          # Extract summary
          if grep -q "0 failures\|0 errors" test-output.log; then
            echo "✅ Unit tests passed"
          else
            echo "❌ Unit tests failed"
            exit 1
          fi

      - name: Verify generated vectors are up-to-date
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking if generated vectors need refresh..."

          # Run generator to ensure vectors are current
          crystal scripts/generate_vectors.cr

          # Check for uncommitted changes
          if ! git diff --exit-code -- spec/fixtures &>/dev/null; then
            echo "::error ::Generated fixtures are out of date!"
            echo "Run 'crystal scripts/generate_vectors.cr' locally and commit the changes."
            git --no-pager --no-color diff -- spec/fixtures | head -100
            exit 1
          else
            echo "✅ Generated vectors are up-to-date"
          fi

      - name: Run generator spec
        shell: bash
        run: |
          set -euo pipefail
          echo "Running generator spec..."
          crystal spec spec/generate_vectors_spec.cr

  example-xxhsum:
    name: "Example: xxhsum corpus [${{ matrix.os }}]"
    runs-on: ${{ matrix.os }}
    # only use the container on linux; windows/macOS don't support container jobs
    container: ${{ matrix.os == 'ubuntu-latest' && 'crystallang/crystal' || '' }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]  # windows dropped; Crystal installation there was unreliable

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Ensure Crystal is installed
        shell: bash
        run: |
          set -euo pipefail
          if command -v crystal >/dev/null 2>&1; then
            echo "Crystal already available: $(crystal --version)"
          else
            echo "Installing Crystal for "/"$(uname)"""
            if [ "$(uname)" = "Darwin" ]; then
              # macOS: use Homebrew (runner already has brew)
              brew update || true
              brew install crystal-lang || true
            elif [ "$(uname)" = "Linux" ]; then
              # Container image already provides crystal in most cases;
              # if not, fall back to installer but assume root access.
              if ! command -v curl >/dev/null 2>&1; then
                apt-get update && apt-get install -y curl
              fi
              curl -fsSL https://crystal-lang.org/install.sh | bash
            elif [[ "$(uname)" == MINGW* || "$(uname)" == MSYS* ]]; then
              # Windows: use chocolatey (preinstalled on hosted runners)
              choco install -y crystal
            else
              # Fallback (unknown/unix-like)
              curl -fsSL https://crystal-lang.org/install.sh | bash
            fi
          fi
          export PATH="$HOME/.local/bin:$PATH"

      - name: Mark repository safe for Git (Linux only)
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd examples/xxhsum
          shards install --ignore-crystal-version || true
          # sanity-check: make sure vendor library exists or rebuild it
          if [ -d ../vendor/xxhash-wrapper ]; then
            echo "=== vendor library directory contents ==="
            ls -l ../vendor/xxhash-wrapper/build || true
            if [ ! -f ../vendor/xxhash-wrapper/build/libxxh3_wrapper_static.a ]; then
              echo "library missing, rebuilding inside example job"
              cd ../vendor/xxhash-wrapper
              # ensure submodules are updated if checkout missed them in container context
              git submodule update --init --recursive
              meson setup build . --wipe 2>/dev/null || meson setup build .
              meson compile -C build
              cd - >/dev/null
            fi
            ls -l ../vendor/xxhash-wrapper/build
          fi

      - name: Run xxhsum example corpus (NORMALIZE_EOL=1)
        shell: bash
        env:
          NORMALIZE_EOL: 1
        run: |
          set -euo pipefail
          cd examples/xxhsum
          echo "Running xxhsum corpus with NORMALIZE_EOL=1"
          NORMALIZE_EOL=1 crystal spec spec/cli_corpus_spec.cr -v

      - name: Example summary
        if: always()
        shell: bash
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "  Example: xxhsum corpus [${{ runner.os }}]"
          echo "════════════════════════════════════════════════════════════"
