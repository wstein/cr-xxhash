name: "Crystal CI - Fast (PR smoke)"

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

jobs:
  fast-tests:
    name: Fast tests — Unit + Generator check
    runs-on: ubuntu-latest
    container:
      image: crystallang/crystal

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Mark repository safe for Git (CI container)
        shell: bash
        run: |
          # Git may detect 'dubious ownership' inside the container; mark workspace safe for CI
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          # Install meson and ninja (APT/APK/DNF/pip fallback) so C build steps work in the container
          if ! command -v meson >/dev/null || ! command -v ninja >/dev/null; then
            if command -v apt-get >/dev/null; then
              apt-get update && apt-get install -y meson ninja-build
            elif command -v apk >/dev/null; then
              apk add --no-cache meson ninja
            elif command -v dnf >/dev/null; then
              dnf install -y meson ninja-build
            else
              python3 -m pip install --user meson ninja
              export PATH="$HOME/.local/bin:$PATH"
            fi
          fi

          # Initialize nested xxHash submodule inside xxhash-wrapper
          # (shards install may skip postinstall hooks in CI)
          if [ -d vendor/xxhash-wrapper ]; then
            cd vendor/xxhash-wrapper
            git submodule update --init --recursive vendor/xxHash || true
            cd - >/dev/null
          fi

          shards install --ignore-crystal-version || true

          # Ensure wrapper static library is present — some CI images skip postinstall hooks
          if [ -f vendor/xxhash-wrapper/meson.build ]; then
            echo "Building vendored xxhash-wrapper static library..."
            # specify source directory explicitly so meson can find meson.build on CI
            meson setup vendor/xxhash-wrapper/build vendor/xxhash-wrapper --wipe 2>/dev/null || meson setup vendor/xxhash-wrapper/build vendor/xxhash-wrapper
            meson compile -C vendor/xxhash-wrapper/build
            ln -sf libxxh3_wrapper_static.a vendor/xxhash-wrapper/build/libxxh3_wrapper.a || true
          fi

      - name: Run unit tests
        shell: bash
        run: |
          set -euo pipefail
          echo "Running unit tests (fast smoke tests)..."
          # Run only unit tests (excluding integration and slow tests)
          crystal spec spec/unit/ spec/bindings_safe_spec.cr spec/version_spec.cr 2>&1 | tee test-output.log

          # Extract summary
          if grep -q "0 failures\|0 errors" test-output.log; then
            echo "✅ Unit tests passed"
          else
            echo "❌ Unit tests failed"
            exit 1
          fi

      - name: Verify generated vectors are up-to-date
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking if generated vectors need refresh..."

          # Run generator to ensure vectors are current
          crystal scripts/generate_vectors.cr

          # Check for uncommitted changes
          if ! git diff --exit-code -- spec/fixtures &>/dev/null; then
            echo "::error ::Generated fixtures are out of date!"
            echo "Run 'crystal scripts/generate_vectors.cr' locally and commit the changes."
            git --no-pager --no-color diff -- spec/fixtures | head -100
            exit 1
          else
            echo "✅ Generated vectors are up-to-date"
          fi

      - name: Run generator spec
        shell: bash
        run: |
          set -euo pipefail
          echo "Running generator spec..."
          crystal spec spec/generate_vectors_spec.cr

  example-xxhsum:
    name: "Example: xxhsum corpus [${{ matrix.os }}]"
    runs-on: ${{ matrix.os }}
    # only use the container on linux; windows/macOS don't support container jobs
    container: ${{ matrix.os == 'ubuntu-latest' && 'crystallang/crystal' || '' }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Setup Crystal
        # Install Crystal on all platforms so `crystal` is available (Linux host runners lack Docker)
        uses: crystal-lang/install-crystal@v1
        with:
          crystal: latest

      - name: Mark repository safe for Git (Linux only)
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          cd examples/xxhsum
          shards install --ignore-crystal-version || true

      - name: Run xxhsum example corpus (NORMALIZE_EOL=1)
        shell: bash
        env:
          NORMALIZE_EOL: 1
        run: |
          set -euo pipefail
          cd examples/xxhsum
          echo "Running xxhsum corpus with NORMALIZE_EOL=1"
          NORMALIZE_EOL=1 crystal spec spec/cli_corpus_spec.cr -v

      - name: Example summary
        if: always()
        shell: bash
        run: |
          echo "════════════════════════════════════════════════════════════"
          echo "  Example: xxhsum corpus [${{ runner.os }}]"
          echo "════════════════════════════════════════════════════════════"
