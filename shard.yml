name: cr-xxhash
version: 0.1.0

description: |
  High-performance Crystal implementation of Yann Collet's xxHash algorithm.
  Optimized for LLVM and SIMD.

authors:
  - Werner Stein <werner.stein@gmail.com>

targets:
  xxhsum:
    main: src/xxhsum.cr

crystal: ">= 1.19.0"

# Automatically compile vendored xxHash C library and create CLI aliases
# Build uses conservative, overrideable performance flags and parallel make.
scripts:
  postinstall: |
    # Determine CPU cores (portable fallback)
    NPROC=$(getconf _NPROCESSORS_ONLN 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)

    # Defaults: tuned for runtime performance but can be overridden by env vars
    : "${XXHASH_CFLAGS:=-O3 -march=native -mtune=native -DNDEBUG -fomit-frame-pointer -funroll-loops}"
    : "${XXHASH_LDFLAGS:=-Wl,-O1}"
    : "${XXHASH_MAKEFLAGS:=-j$NPROC}"

    echo "Building vendor/xxHash (CFLAGS=\"$XXHASH_CFLAGS\", MAKEFLAGS=\"$XXHASH_MAKEFLAGS\")"

    export CFLAGS="$XXHASH_CFLAGS" LDFLAGS="$XXHASH_LDFLAGS" MAKEFLAGS="$XXHASH_MAKEFLAGS"

    # Build object & static library (Makefile in vendor/xxHash picks up CFLAGS/LDFLAGS)
    make -C vendor/xxHash xxhash.o libxxhash.a

    # CLI symlinks
    mkdir -p bin
    ln -sf xxhsum ./bin/xxh32sum
    ln -sf xxhsum ./bin/xxh64sum
    ln -sf xxhsum ./bin/xxh128sum
    ln -sf xxhsum ./bin/xxh3sum

license: BSD-2-Clause
