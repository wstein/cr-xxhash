= Migration Paper: High-Performance xxHash Implementation in Crystal Language
Yann Collet's xxHash Migration Project
:toc: left
:toclevels: 3
:sectnums:
:sectanchor:
:source-highlighter: highlightjs
:doctype: book
:version: 0.1.0
:revdate: 2026-02-11
:author: Werner Stein <werner.stein@gmail.com>
:audience: Students and Senior Developers
:throughput_autovec: XXH3 30 GB/s (via LLVM Auto-Vectorization)

[abstract]
This paper documents the academic and technical migration of the xxHash library from C99 to Crystal. It focuses on the discovery that **LLVM auto-vectorization** (targeting ~30 GB/s) provides a superior balance of performance and maintainability compared to manual SIMD intrinsics.

== Executive summary

This paper documents the design decisions, implementation trade-offs, and empirical benchmarks for porting xxHash to Crystal. Key outcomes achieved: parity with the C reference (bit-identical hashes), high throughput ({throughput_autovec}), and a conclusion that modern compilers (LLVM 18+) reach ~60% of handwritten SIMD performance given the correct Crystal idioms.

include::migration/01_introduction_and_goals.adoc[]
include::migration/02_architecture_constraints.adoc[]
include::migration/03_context_and_scope.adoc[]
include::migration/04_solution_strategy.adoc[]
include::migration/05_building_block_view.adoc[]
include::migration/06_runtime_view.adoc[]
include::migration/08_concepts.adoc[]
include::migration/09_architecture_decisions.adoc[]
include::migration/10_quality_requirements.adoc[]
include::migration/11_benchmark_implementation.adoc[]
include::migration/12_native_implementation_strategy.adoc[]

== Reproducibility

To aid reproducible measurement, this repository includes helper scripts and guidance:

* link:papers/CONTRIBUTING.adoc[Contributing & Performance Methodology]
* link:scripts/README.md[Scripts README — tool_versions.rb]
* link:vendor/xxHash/LICENSE[Upstream xxHash license]

Tips: Include the output of `ruby scripts/tool_versions.rb --json` with each benchmark run and attach it to CI artifacts.

== Benchmarking & Performance Optimizations

This project now includes a vendor-compatible benchmarking mode (`-b` / `-bX`) to reproduce throughput claims and validate implementation parity. The benchmark uses a 100 KB sample buffer by default and prints per-variant statistics in a vendor-compatible layout (e.g., `1#XXH32 : 102400 -> 128640 it/s (12562.5 MB/s)`).

Performance optimizations implemented in the Crystal port are documented in `PERFORMANCE_OPTIMIZATIONS.md` and include:

* Zero-copy hex conversion and pre-allocated byte buffers to eliminate intermediate String allocations
* Slice-based (Bytes) processing instead of String copies for binary data
* Branch-friendly bit-shifting for endianness conversion on hot paths

Measured results on Apple M4 show XXH3/XXH128 throughput in the ~45–49 GB/s range, competitive with the upstream C implementation. Please refer to `PERFORMANCE_OPTIMIZATIONS.md` for implementation details and microbenchmarks.
