= Contributing to cr-xxhash
:toc:
:sectnums:

Welcome to the `cr-xxhash` project. As a high-performance migration study, we maintain rigorous standards for code quality, architectural consistency, and performance verification.

== Development Philosophy

This project aims to bridge the gap between low-level C optimization and High-level Crystal abstractions. Contributions should prioritize:
1. **Performance**: Avoid heap allocations in hot paths. Use `Pointer` and `Intrinsics` where justified.
2. **Correctness**: Every change must pass the reference test vectors from `vendor/xxHash`.
3. **Clarity**: Use Crystal-idiomatic wrappers around unsafe operations to ensure the public API remains pleasant to use.

== Workflow

1. **Fork and Branch**: Create a feature branch for your implementation or research.
2. **Implementation**:
    * If porting a new SIMD path, provide the corresponding LLVM intrinsics mapping.
    * Use `@[AlwaysInline]` for logic that must be optimized across call boundaries.
3. **Validation**:
    * Run `crystal spec` to ensure zero regressions.
    * Run the integration tests: `crystal spec/integration_test.cr` (validates vendor parity).
    * Test FFI bindings: The test suite uses a dedicated FFI binding kept at `spec/support/bindings.cr` (required by `spec/support/libxxh_helper.cr`) as the canonical validation oracle. If you update C-side behavior or vendor fixtures, update this file and ensure the vendor library is built (e.g., `make -C vendor/xxHash libxxhash.a`) before running specs.

    * Maintenance note: Keep `spec/support/bindings.cr` synchronized with changes to `vendor/xxHash`. When updating vendor C code, also update or add tests that assert parity (for example, comparing `SpecFFI` results with native `XXH::*` outputs) and rebuild the vendor library (`make -C vendor/xxHash libxxhash.a`) so CI and local runs validate the new behavior.
    * Run the benchmark and include results in your PR when performance changes are involved:
        **`./bin/xxhsum -b`** (all variants) or **`./bin/xxhsum -bX`** (vendor-style variant id; e.g., `-b3`, `-b11`).
    * Use `scripts/tool_versions.rb` to document your environment in the PR description.
== Aliases & Local Bin

For developer convenience this project creates lightweight CLI aliases that default to algorithm-specific behavior (matching the vendor tool). The aliases are:

* `./bin/xxh32sum` → XXH32 (equivalent to `./bin/xxhsum -H0`)
* `./bin/xxh64sum` → XXH64 (equivalent to `./bin/xxhsum -H1`)
* `./bin/xxh128sum` → XXH128 (equivalent to `./bin/xxhsum -H2`)
* `./bin/xxh3sum`  → XXH3  (equivalent to `./bin/xxhsum -H3`)

These aliases are created by the `postinstall` script defined in `shard.yml` (runs during `shards install`). The `./bin` directory is ignored by `.gitignore`, so you may need to recreate aliases locally. To recreate them manually, run:

[source,shell]
----
make -C vendor/xxHash libxxhash.a
mkdir -p bin
ln -sf ./bin/xxhsum ./bin/xxh32sum
ln -sf ./bin/xxhsum ./bin/xxh64sum
ln -sf ./bin/xxhsum ./bin/xxh128sum
ln -sf ./bin/xxhsum ./bin/xxh3sum
----

Or simply run `shards install` to execute the `postinstall` hook automatically.

4. **Pull Request**: Detail the performance implications. If applicable, include a `bench` output.

== Technical Standards

* **C99 Parity**: We follow the `xxHash` specification versioning.
* **Code Style**: Standard `crystal tool format`.
* **Documentation**: Major architectural changes must be reflected in the link:migration/index.adoc[Migration Paper].

---
*Based on the outstanding work of Yann Collet and the xxHash project.*
